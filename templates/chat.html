<!DOCTYPE html>
<html>
<head>
  <title>Chat</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
</head>
<body>

<a href="/home">Home</a> | <a href="/logout">Logout</a>

<div id="chat">
  {% for m in messages %}
    <div class="bubble {{ 'me' if m.user == username else 'other' }}">
      <b><a href="/profile/{{ m.user }}">{{ m.user }}</a></b><br>
      {{ m.text }}
      <span>{{ m.timestamp }}</span>
    </div>
  {% endfor %}
</div>

<div id="typing"></div>

<div id="input">
  <input
    id="msg"
    placeholder="Type..."
    oninput="typing()"
    onkeydown="if (event.key === 'Enter') send()"
  />
  <button onclick="send()">Send</button>
</div>

<script>
  const socket = io("https://web-chat-app-frdo.onrender.com", {
    transports: ["websocket"],
    upgrade: false,
    query: { username: "{{ username }}" }
  });

  socket.on("chat_message", data => {
    const div = document.createElement("div");
    div.className = "bubble " + (data.user === "{{ username }}" ? "me" : "other");
    div.innerHTML = `<b><a href="/profile/${data.user}">${data.user}</a></b><br>${data.text}<span>${data.time}</span>`;
    document.getElementById("chat").appendChild(div);
    document.getElementById("chat").scrollTop = document.getElementById("chat").scrollHeight;
  });

  function send() {
    const msg = document.getElementById("msg").value;
    if (msg.trim() === "") return;
    socket.emit("chat_message", msg);
    document.getElementById("msg").value = "";
  }

  function typing() {
    socket.emit("typing");
  }
</script>

</body>
</html>
