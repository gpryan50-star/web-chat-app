<!DOCTYPE html>
<html>
<head>
  <title>Chat</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
</head>
<body>

<div id="chat">
  {% for m in messages %}
    <div class="bubble {{ 'me' if m.user == username else 'other' }}">
      <b>{{ m.user }}</b><br>{{ m.text }}
      <span>{{ m.time }}</span>
    </div>
  {% endfor %}
</div>

<div id="typing"></div>

<div id="input">
  <input id="msg" placeholder="Type..." oninput="typing()" />
  <button onclick="send()">Send</button>
</div>

<script>
const socket = io();

socket.on("message", data => {
  const div = document.createElement("div");
  div.className = "bubble " + (data.user === "{{username}}" ? "me" : "other");
  div.innerHTML = `<b>${data.user}</b><br>${data.text}<span>${data.time}</span>`;
  document.getElementById("chat").appendChild(div);
  document.getElementById("chat").scrollTop = 99999;
});

socket.on("typing", user => {
  document.getElementById("typing").innerText = `${user} is typing...`;
  setTimeout(() => document.getElementById("typing").innerText = "", 1000);
});

function send() {
  const input = document.getElementById("msg");
  if (input.value.trim()) {
    socket.send(input.value);
    input.value = "";
  }
}

function typing() {
  socket.emit("typing");
}
</script>

</body>
</html>
